---
title: "final project.rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rtracklayer)
library(AnnotationHub)
ah <- AnnotationHub()

#PAX5 binding
#a bunch of different proteins
pax5.experiments <- query(ah, c("PAX5", "Tfbs", "UniPk"))
rest.experiments <- query(ah, c("REST", "Tfbs", "UniPk"))
usf1.experiments <- query(ah, c("USF1", "Tfbs", "UniPk"))
max.experiments <- query(ah, c("MAX", "Tfbs", "UniPk"))
jund.experiments <- query(ah, c("JUND", "Tfbs", "UniPk"))
yy1.experiments <- query(ah, c("YY1", "Tfbs", "UniPk"))
gabpa.experiments <- query(ah, c("GABPA", "Tfbs", "UniPk"))

#pulls summarized experiment for cell line a protein
get.exp <- function(cell.line, protein){
  
  cell.protein.query <- query(ah, c(cell.line, protein, "Tfbs", "UniPk"))
  if (length(cell.protein.query) == 0){
    
    print(paste("No matches for", paste(cell.line, protein)))
    
  }
  if( length(cell.protein.query) > 0){
    
    query(ah, c(cell.line, protein,"Tfbs", "UniPk"))[[1]]
    
  }
}

library("BSgenome.Hsapiens.UCSC.hg19")
extract.seq <- function(exp.data, protein){
  
  #make widths of sequence the same 
  #for now choosing 250 bases

  #first subset out small peaks 
  target.peaks <- exp.data[width(exp.data) > 250, ]

  #get the middle of ranges with more than 250 peaks 
  new.seqs <- target.peaks - round((width(target.peaks) - 250)/2)
  new.seqs <- resize(new.seqs, 250)
  
  #extract sequences 
  seqs <- getSeq(Hsapiens, new.seqs)
  
  #make list of characters
  seq.chars <- as.character(seqs)
  
  #go through each element and split it into indiviudal bases, make a matrix 
  seq.df <- data.frame(matrix(unlist(lapply(seq.chars, strsplit, split = "")), ncol = 250, byrow = TRUE))
  
  #add in protein name 
  seq.df$protein <- protein
  return(seq.df)
  
}

#function to run svm on two proteins from same cell line 
run.svm <- function(protein1, protein2, cell.line){
  
  #pull down data 
  protein1.chip <- get.exp(cell.line, protein1)
  protein2.chip <- get.exp(cell.line, protein2)
  protein1.diffs <- setdiff(protein1.chip, protein2.chip)
  protein2.diffs <- setdiff(protein2.chip, protein1.chip)
  
  #get dfs for protein1 and protein2 
  protein1.seq <- extract.seq(protein1.diffs, protein1)
  protein2.seq <- extract.seq(protein2.diffs, protein2)
  
  #split into test and training sets
  set.seed(14)
  
  protein1.training.rows <- sample(1:nrow(protein1.seq), round(nrow(protein1.seq)*.8))
  protein1.test.rows <- setdiff(1:nrow(protein1.seq), protein1.training.rows)
  protein1.training <- protein1.seq[protein1.training.rows, ]
  protein1.test <- protein1.seq[protein1.test.rows, ]
  
  protein2.training.rows <- sample(1:nrow(protein2.seq), round(nrow(protein2.seq)*.8))
  protein2.test.rows <- setdiff(1:nrow(protein2.seq), protein2.training.rows)
  protein2.training <- protein2.seq[protein2.training.rows, ]
  protein2.test <- protein2.seq[protein2.test.rows, ]
  
  #bind together 
  svm.training.data <- rbind(protein1.training, protein2.training)
  svm.test.data <- rbind(protein1.test, protein2.test)
  
  #run svm 
  library(kernlab)
  svm.res <- ksvm(protein ~ ., data = svm.training.data)
  
  #predict on test data 
  predictions <- predict(svm.res, svm.test.data[ , colnames(svm.test.data != "protein")])
  
  return(list(observed = svm.test.data$protein, predicted = predictions))
  
}

test <- run.svm("JUND", "MAX", "GM12878")

